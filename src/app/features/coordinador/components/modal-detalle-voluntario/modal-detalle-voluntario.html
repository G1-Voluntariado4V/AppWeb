<div
  class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity animate-in fade-in duration-200"
  (click)="cerrar()">

  <div
    class="bg-white rounded-3xl shadow-2xl w-full max-w-4xl overflow-hidden h-[80vh] flex flex-col md:flex-row animate-in zoom-in-95 duration-200"
    (click)="$event.stopPropagation()">

    <!-- Sidebar Lateral -->
    <div
      class="w-full md:w-72 bg-gray-50/80 backdrop-blur-sm p-8 border-r border-gray-100 flex flex-col items-center text-center">
      <div
        class="w-28 h-28 rounded-full bg-white flex items-center justify-center mb-4 relative shadow-lg ring-4 ring-white overflow-hidden shrink-0 border border-gray-200">
        @if (vData().foto) {
        <img [src]="vData().foto" alt="Avatar" class="w-full h-full object-cover">
        } @else {
        <span class="text-3xl font-bold text-gray-400">{{ vData().nombre.substring(0,2).toUpperCase() }}</span>
        }
      </div>

      <h2 class="text-lg font-bold text-gray-900 leading-tight mb-1">{{ vData().nombre }}</h2>
      <p class="text-sm text-gray-500 mb-2 font-medium">{{ vData().curso || 'Sin curso asignado' }}</p>

      <span class="px-3 py-1 rounded-full text-xs font-bold mb-8 border" [ngClass]="{
              'bg-green-100 text-green-700 border-green-200': vData().estado === 'Activa',
              'bg-orange-100 text-orange-700 border-orange-200': vData().estado === 'Pendiente',
              'bg-red-100 text-red-700 border-red-200': vData().estado === 'Bloqueada' || vData().estado === 'Rechazada'
            }">
        {{ vData().estado }}
      </span>

      <div
        class="bg-white rounded-2xl p-5 w-full shadow-sm border border-gray-100 mb-4 group hover:shadow-md transition-all">
        <p class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider">Actividades Aprobadas</p>
        <p class="text-3xl font-bold text-[#2563eb] group-hover:scale-110 transition-transform">{{ actividadesCount() }}
        </p>
      </div>

      <div
        class="bg-white rounded-2xl p-5 w-full shadow-sm border border-gray-100 mb-4 group hover:shadow-md transition-all">
        <p class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider">Horas Totales</p>
        <p class="text-3xl font-bold text-violet-600 group-hover:scale-110 transition-transform">{{ horasTotales() }}h
        </p>
      </div>
    </div>

    <!-- Contenido Principal -->
    <div class="flex-1 p-8 overflow-y-auto bg-white custom-scrollbar-thin relative">
      <div class="flex justify-between items-start mb-8 pb-4 border-b border-gray-100">
        <div>
          <h3 class="text-xl font-bold text-gray-900">Información personal</h3>
          <p class="text-gray-500 text-xs mt-1 font-medium">Detalles y datos de contacto.</p>
        </div>
        <div class="flex gap-2">
          @if (!editando()) {
          <button (click)="iniciarEdicion()"
            class="px-4 py-2 border border-gray-200 rounded-xl text-xs font-bold hover:bg-violet-50 hover:border-violet-200 hover:text-violet-600 transition-colors flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3">
              <path
                d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" />
              <path
                d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" />
            </svg>
            Editar
          </button>
          }
          <button (click)="cerrar()"
            class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center hover:bg-gray-100 transition-colors cursor-pointer text-gray-400 hover:text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path
                d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Vista de solo lectura -->
      @if (!editando()) {
      <div class="grid grid-cols-2 gap-y-8 gap-x-8 mb-10">
        <div>
          <p class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider">Nombre completo</p>
          <p class="font-bold text-gray-900 text-sm">{{ vData().nombre }} {{ vData().apellidos }}</p>
        </div>
        <div>
          <p class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider">Email</p>
          <p class="font-bold text-gray-900 text-sm break-all font-mono text-xs bg-gray-50 p-2 rounded-lg inline-block">
            {{ vData().email }}</p>
        </div>

        <div>
          <p class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider">DNI/NIE</p>
          <p class="font-bold text-gray-900 text-sm">{{ vData().dni || 'No registrado' }}</p>
        </div>
        <div>
          <p class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider">Teléfono</p>
          <p class="font-bold text-gray-900 text-sm">{{ vData().telefono || 'No registrado' }}</p>
        </div>

        <div>
          <p class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider">Curso</p>
          <span class="font-bold text-gray-700 text-xs bg-gray-100 px-2 py-1 rounded inline-block">{{ vData().curso ||
            'No asignado' }}</span>
        </div>
        <div>
          <p class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider">Fecha nacimiento</p>
          <p class="font-bold text-gray-900 text-sm">{{ vData().fecha_nac || 'No registrada' }}</p>
        </div>

        <div class="col-span-2">
          <p class="text-[10px] font-bold text-gray-400 uppercase mb-2 tracking-wider">Idiomas</p>
          <div class="flex flex-wrap gap-2">
            @for (lang of getIdiomasVoluntario(); track lang.id_idioma) {
            <div class="px-3 py-1.5 rounded-lg bg-gray-50 border border-gray-100 flex items-center gap-2">
              <span class="text-sm font-semibold text-gray-700">{{ lang.idioma }}</span>
              <span class="text-xs font-bold text-white bg-violet-500 rounded px-1.5 py-0.5">{{ lang.nivel }}</span>
            </div>
            }
            @if (getIdiomasVoluntario().length === 0) {
            <span class="text-xs text-gray-400 italic">No hay idiomas registrados</span>
            }
          </div>
        </div>

        @if (vData().descripcion) {
        <div class="col-span-2">
          <p class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider">Descripción / Notas</p>
          <p class="text-sm text-gray-600 italic bg-gray-50 p-3 rounded-xl border border-gray-100">{{
            vData().descripcion }}</p>
        </div>
        }
      </div>
      }

      <!-- Vista de edición -->
      @if (editando()) {
      <div class="grid grid-cols-2 gap-y-4 gap-x-8 mb-6 animate-in slide-in-from-right-4 duration-200">
        <div class="col-span-1">
          <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider block">Nombre</label>
          <input type="text" [(ngModel)]="nombreEditable"
            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:border-violet-500 focus:ring-2 focus:ring-violet-100 font-medium transition-all outline-none">
        </div>
        <div class="col-span-1">
          <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider block">Apellidos</label>
          <input type="text" [(ngModel)]="apellidosEditable"
            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:border-violet-500 focus:ring-2 focus:ring-violet-100 font-medium transition-all outline-none">
        </div>
        <div class="col-span-1">
          <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider block">Teléfono</label>
          <input type="tel" [(ngModel)]="telefonoEditable"
            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:border-violet-500 focus:ring-2 focus:ring-violet-100 font-medium transition-all outline-none">
        </div>

        <!-- EMAIL Readonly -->
        <div class="col-span-1 opacity-60 cursor-not-allowed">
          <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider block">Email</label>
          <div
            class="w-full bg-gray-100 border border-gray-200 rounded-xl px-4 py-3 text-sm text-gray-500 font-mono text-xs">
            {{ vData().email }}
          </div>
        </div>

        <!-- DNI Readonly -->
        <div class="col-span-1 opacity-60 cursor-not-allowed">
          <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider block">DNI/NIE</label>
          <input type="text" [value]="vData().dni || ''" disabled
            class="w-full bg-gray-100 border border-gray-200 rounded-xl px-4 py-3 text-sm text-gray-500 font-medium cursor-not-allowed outline-none">
        </div>

        <!-- Fecha Nacimiento -->
        <div class="col-span-1">
          <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider block">Fecha
            Nacimiento</label>
          <input type="date" [(ngModel)]="fechaNacEditable"
            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:border-violet-500 focus:ring-2 focus:ring-violet-100 font-medium transition-all outline-none">
        </div>

        <!-- SELECTOR DE CURSO (DOBLE: NIVEL Y CICLO) -->
        <div class="col-span-1">
          <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider block">Curso (Nivel)</label>
          <select [ngModel]="selectedLevel()" (ngModelChange)="onLevelChange($event)"
            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:border-violet-500 focus:ring-2 focus:ring-violet-100 font-medium transition-all outline-none appearance-none">
            <option [ngValue]="1">1º</option>
            <option [ngValue]="2">2º</option>
          </select>
        </div>

        <div class="col-span-1">
          <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider block">Ciclo Formativo</label>
          <select [(ngModel)]="selectedCursoId"
            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:border-violet-500 focus:ring-2 focus:ring-violet-100 font-medium transition-all outline-none appearance-none">
            <option [ngValue]="null" disabled>Selecciona ciclo</option>
            @for (curso of availableCycles(); track curso.id) {
            <option [ngValue]="curso.id">{{ curso.nombre }}</option>
            }
          </select>
        </div>

        <div class="col-span-2 mt-4 pt-4 border-t border-gray-100">
          <label class="text-[10px] font-bold text-gray-400 uppercase mb-3 tracking-wider block">Gestión de
            Idiomas</label>

          <!-- Lista de idiomas actuales -->
          <div class="space-y-3 mb-4">
            @for (lang of getIdiomasVoluntario(); track lang.id_idioma) {
            <div class="flex items-center gap-3 bg-white p-2 rounded-xl border border-gray-200">
              <div class="flex-1 font-medium text-sm text-gray-700 ml-2">{{ lang.idioma }}</div>
              <select [ngModel]="lang.nivel" (ngModelChange)="actualizarNivelIdioma(lang.id_idioma, $event)"
                class="bg-gray-50 border border-gray-200 rounded-lg text-xs font-bold px-2 py-1 outline-none focus:border-violet-500">
                @for (opt of nivelesIdiomas; track opt) {
                <option [value]="opt">{{ opt }}</option>
                }
              </select>
              <button (click)="eliminarIdioma(lang.id_idioma)"
                class="p-2 text-gray-400 hover:text-red-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                  <path fill-rule="evenodd"
                    d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 001.5.06l.3-7.5z"
                    clip-rule="evenodd" />
                </svg>
              </button>
            </div>
            }
          </div>

          <!-- Añadir nuevo idioma -->
          <div class="flex gap-2 items-center bg-gray-50 p-2 rounded-xl border border-gray-200 border-dashed">
            <select [(ngModel)]="nuevoIdiomaId"
              class="flex-1 bg-transparent text-sm font-medium outline-none px-2 py-1">
              <option [ngValue]="null">Añadir idioma...</option>
              @for (ii of idiomasDisponibles(); track ii.id) {
              <option [ngValue]="ii.id">{{ ii.nombre }}</option>
              }
            </select>
            <select [(ngModel)]="nuevoIdiomaNivel"
              class="w-20 bg-white border border-gray-200 rounded-lg text-xs font-bold px-2 py-1 outline-none">
              @for (opt of nivelesIdiomas; track opt) {
              <option [value]="opt">{{ opt }}</option>
              }
            </select>
            <button (click)="agregarIdioma()" [disabled]="!nuevoIdiomaId"
              class="px-3 py-1.5 bg-violet-600 text-white rounded-lg text-xs font-bold hover:bg-violet-700 disabled:opacity-50 disabled:cursor-not-allowed">
              Añadir
            </button>
          </div>
        </div>
      </div>

      <div class="mb-6 animate-in slide-in-from-right-4 duration-200 delay-75">
        <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider block">Descripción /
          Notas</label>
        <textarea [(ngModel)]="descripcionEditable" rows="3"
          placeholder="Añade notas o información adicional sobre este voluntario..."
          class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:border-violet-500 focus:ring-2 focus:ring-violet-100 resize-none font-medium transition-all outline-none"></textarea>
      </div>

      <div
        class="flex justify-end gap-3 pt-6 border-t border-gray-100 animate-in slide-in-from-bottom-2 duration-200 delay-100">
        <button (click)="cancelarEdicion()"
          class="px-6 py-2.5 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition-colors text-xs uppercase tracking-wide">
          Cancelar
        </button>
        <button (click)="guardarCambios()" [disabled]="guardando()"
          class="px-6 py-2.5 bg-violet-600 text-white font-bold rounded-xl shadow-lg shadow-violet-200 hover:bg-violet-700 hover:shadow-xl transition-all disabled:opacity-50 disabled:shadow-none flex items-center gap-2 text-xs uppercase tracking-wide">
          @if (guardando()) {
          <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
          </svg>
          Guardando...
          } @else {
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
            <path fill-rule="evenodd"
              d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z"
              clip-rule="evenodd" />
          </svg>
          Guardar cambios
          }
        </button>
      </div>
      }

      <!-- Historial (solo en vista lectura) -->
      @if (!editando()) {
      <div class="mt-8">
        <h3 class="text-sm font-bold text-gray-900 mb-4 flex items-center gap-2 uppercase tracking-wide">
          Actividad reciente
          @if (cargandoHistorial()) {
          <svg class="animate-spin h-3 w-3 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
          </svg>
          }
        </h3>

        <div class="border border-gray-100 rounded-xl overflow-hidden shadow-sm">
          <table class="w-full text-left">
            <thead class="bg-gray-50 text-[10px] text-gray-400 uppercase font-bold tracking-wider">
              <tr>
                <th class="px-4 py-3 border-b border-gray-100">Actividad</th>
                <th class="px-4 py-3 border-b border-gray-100">Fecha</th>
                <th class="px-4 py-3 text-right border-b border-gray-100">Estado</th>
              </tr>
            </thead>
            <tbody class="text-xs font-medium">
              @for (h of historial(); track h.id_inscripcion) {
              <tr
                class="border-b border-gray-50 last:border-0 hover:bg-blue-50/50 transition-colors cursor-pointer group"
                (click)="verActividad(h.id_actividad)">
                <td class="px-4 py-3 text-gray-900">
                  <div class="font-bold group-hover:text-blue-600 transition-colors">{{ h.titulo_actividad ||
                    h.actividad }}</div>
                  <div class="text-[10px] text-gray-400 font-medium mt-0.5">{{ h.organizacion }}</div>
                </td>
                <td class="px-4 py-3 text-gray-500 font-mono text-[10px]">{{ h.fecha_actividad | date:'d MMM yyyy' }}
                </td>
                <td class="px-4 py-3 text-right">
                  <span class="px-2 py-1 rounded-md bg-gray-50 border border-gray-100 text-gray-600" [ngClass]="{
                        'bg-green-50 text-green-700 border-green-100': (h.estado || h.estado_solicitud || h.status) === 'Aceptada',
                        'bg-blue-50 text-blue-700 border-blue-100': (h.estado || h.estado_solicitud || h.status) === 'Finalizada',
                        'bg-orange-50 text-orange-700 border-orange-100': (h.estado || h.estado_solicitud || h.status) === 'Pendiente',
                        'bg-red-50 text-red-700 border-red-100': (h.estado || h.estado_solicitud || h.status) === 'Rechazada' || (h.estado || h.estado_solicitud || h.status) === 'Cancelada'
                    }">
                    {{ h.estado || h.estado_solicitud || h.status }}
                  </span>
                </td>
              </tr>
              }
              @if (!cargandoHistorial() && historial().length === 0) {
              <tr>
                <td colspan="3" class="px-4 py-8 text-center text-gray-400 italic">
                  <p class="text-xs">No ha participado en actividades aprobadas.</p>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
      }
    </div>
  </div>

  <!-- Modal Apilado de Actividad -->
  @if (actividadSeleccionada()) {
  <app-modal-detalle-actividad [act]="actividadSeleccionada()!"
    (close)="cerrarActividad()"></app-modal-detalle-actividad>
  }
</div>

<!-- Modal de confirmación -->
<app-confirm-modal
  [isOpen]="confirmModalVisible()"
  [title]="confirmModalTitle()"
  [message]="confirmModalMessage()"
  [confirmText]="confirmModalButtonText()"
  (confirm)="onConfirmModalConfirm()"
  (cancel)="onConfirmModalCancel()">
</app-confirm-modal>
